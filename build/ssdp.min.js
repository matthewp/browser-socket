(function(){function e(){}function t(){if(!t.BROWSER)throw"This browser doesn't support TCP sockets."}function o(){var t=this;return this instanceof o?(e.call(t),t.usns={},t.udn="uuid:e3f28962-f694-471f-8f74-c6abd507594b",t.sock=s.createSocket("udp4"),t.sock.on("error",function(e){console.log("############### Got an error!"),console.trace(e)}),t.sock.on("message",function(e,o){t.parseMessage(e,o)}),t.sock.on("listening",function(){var e=t.sock.address();console.log("SSDP Listening on "+e.address+":"+e.port),t.sock.addMembership(r),t.sock.setMulticastTTL(2)}),process.on("exit",function(){t.close()}),void 0):new o}e.prototype.on=function(e,t){this.hasOwnProperty("_handlers")||(this._handlers={});var o=this._handlers;o.hasOwnProperty(e)||(o[e]=[]);var s=o[e];s.push(t)},e.prototype.addListener=e.prototype.on,e.prototype.once=function(e,t){function o(){this.off(e,t),this.off(e,o)}this.on(e,t),this.on(e,o)},e.prototype.emit=function(e){if(this.hasOwnProperty("_handlers")){var t=this._handlers;if(t.hasOwnProperty(e))for(var o=t[e],s=Array.prototype.slice.call(arguments,1),n=0,r=o.length;r>n;n++)o[n]&&o[n].apply(this,s)}},e.prototype.off=function(e,t){if(this.hasOwnProperty("_handlers")){var o=this._handlers;if(o.hasOwnProperty(e)){var s=o[e],n=s.indexOf(t);if(!(0>n)&&(s[n]=!1,n===s.length-1))for(;n>=0&&!s[n];)s.length--,n--}}},e.prototype.removeListener=e.prototype.off,navigator.mozTCPSocket&&(t=function(){navigator.mozTCPSocket.apply(this,arguments)},t.prototype=Object.create(navigator.mozTCPSocket.prototype),t.prototype.constructor=t,t.BROWSER="mozilla");var s=require("dgram"),n="Microsoft-Windows-NT/5.1 UPnP/1.1 Mediabrary/1.0",r="239.255.255.250",i=1900,a=r+":"+i,p=1800;o.prototype=Object.create(e.prototype),o.prototype.inMSearch=function(e,t){var o=this,s=t.address,r=t.port;'"'==e[0]&&(e=e.slice(1,-1)),Object.keys(o.usns).forEach(function(t){var i=o.usns[t];if("ssdp:all"==e||t==e){var a=o.getSSDPHeader("200 OK",{ST:t,USN:i,LOCATION:o.httphost+"/upnp/desc.php","CACHE-CONTROL":"max-age="+p,DATE:(new Date).toUTCString(),SERVER:n,EXT:""},!0);console.log("Sending a 200 OK for an m-search to "+s+":"+r),a=new Buffer(a),o.sock.send(a,0,a.length,r,s)}})},o.prototype.addUSN=function(e){this.usns[e]=this.udn+"::"+e},o.prototype.parseMessage=function(e,t){var o=(""+e).split("\r\n").shift();o.match(/HTTP\/(\d{1})\.(\d{1}) (\d+) (.*)/)?this.parseResponse(e,t):this.parseCommand(e,t)},o.prototype.parseCommand=function(e,t){var o=(""+e).split("\r\n"),s=o.shift().split(" "),n=s[0],r=(s[1],this),i={};switch(o.forEach(function(e){if(e.length){var t=e.match(/^([^:]+):\s*(.*)$/);i[t[1].toUpperCase()]=t[2]}}),n){case"NOTIFY":"ssdp:alive"==i.NTS?r.emit("advertise-alive",i):"ssdp:byebye"==i.NTS?r.emit("advertise-bye",i):console.log("############### Notify unhandled!");break;case"M-SEARCH":if(console.log("SSDP M-SEARCH: for ("+i.ST+") from ("+t.address+":"+t.port+")"),!i.MAN)return;if(!i.MX)return;if(!i.ST)return;r.inMSearch(i.ST,t);break;default:console.log("Unknown message: \r\n"+e)}},o.prototype.parseResponse=function(e,t){this.emit("response",e,t)},o.prototype.search=function(e){var t=this;require("dns").lookup(require("os").hostname(),function(o,s){t.sock.bind(0,s);var n=t.getSSDPHeader("M-SEARCH",{HOST:a,ST:e,MAN:'"ssdp:discover"',MX:3});n=new Buffer(n),console.log("@138",""+n),t.sock.send(n,0,n.length,i,r)})},o.prototype.server=function(e){var t=this;this.httphost="http://"+e+":10293",this.usns[this.udn]=this.udn,this.sock.bind(i,e),this.advertise(!1),setTimeout(function(){t.advertise(!1)},1e3),setTimeout(t.advertise,2e3),setTimeout(t.advertise,3e3),setInterval(t.advertise,1e4)},o.prototype.close=function(){this.advertise(!1),this.advertise(!1),this.sock.close()},o.prototype.advertise=function(e){var t=this;this.sock&&(void 0===e&&(e=!0),Object.keys(t.usns).forEach(function(o){var s=t.usns[o],p="NOTIFY * HTTP/1.1\r\n",c={HOST:a,NT:o,NTS:e?"ssdp:alive":"ssdp:byebye",USN:s};e&&(c.LOCATION=t.httphost+"/upnp/desc.php",c["CACHE-CONTROL"]="max-age=1800",c.SERVER=n),p=new Buffer(t.getSSDPHeader("NOTIFY",c)),t.sock.send(p,0,p.length,i,r)}))},o.prototype.getSSDPHeader=function(e,t,o){var s="";return null==o&&(o=!1),s=o?"HTTP/1.1 "+e+"\r\n":e+" * HTTP/1.1\r\n",Object.keys(t).forEach(function(e){s+=e+": "+t[e]+"\r\n"}),s+"\r\n"},module.exports=o})();